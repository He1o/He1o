---
title: 3. Recurrent Neural Network
date: 2022-07-11
category: Deep learning
---
<!--more-->

# å¾ªç¯ç¥ç»ç½‘ç»œ

## 1. å†å²èƒŒæ™¯
1986 å¹´ç”± David Rumelhart æå‡ºï¼Œä¹Ÿå°±æ˜¯æ–¹å‘ä¼ æ’­ç®—æ³•æå‡ºçš„æ—¶å€™ã€‚


## 2. å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹
å¾ªç¯ç¥ç»ç½‘ç»œæ˜¯ä¸€ç§å¤„ç†åºåˆ—æ•°æ®çš„ç¥ç»ç½‘ç»œï¼Œä¾‹å¦‚å¤„ç†è¯­éŸ³å’Œæ–‡æœ¬ã€‚å¾ªç¯ç¥ç»ç½‘ç»œå’Œå·ç§¯ç¥ç»ç½‘ç»œç›¸åŒçš„ä¸€ç‚¹åœ¨äºå…±äº«æƒé‡ï¼Œå¦‚åŒå›¾ç‰‡ä¸­æ¯ä¸ªä¸åŒçš„åŒºåŸŸå®é™…ä¸Šä½¿ç”¨ç›¸åŒçš„å·ç§¯æ ¸è¿›è¡Œè®¡ç®—ï¼Œä¸åŒæ—¶é—´æ®µçš„åºåˆ—æ•°æ®ä¼ å…¥åˆ°åŒä¸€ç¥ç»ç½‘ç»œå±‚ã€‚

å¾ªç¯ç¥ç»ç½‘ç»œä¸å¤šå±‚æ„ŸçŸ¥æœºçš„ç»“æ„æ›´ä¸ºç›¸ä¼¼ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœç”¨å¤šå±‚æ„ŸçŸ¥æœºå¯¹ä¸€å¥è¯è¿›è¡Œæ ‡æ³¨ï¼Œå‡è®¾å¥å­çš„é•¿åº¦éƒ½ä¸º 10ï¼Œé‚£ä¹ˆéœ€è¦è®­ç»ƒ 10 ä¸ªç¥ç»ç½‘ç»œåˆ†åˆ«å¤„ç†ä¸åŒä½ç½®ä¸Šçš„å•è¯ã€‚è€Œå¾ªç¯ç¥ç»ç½‘ç»œä¸­ï¼Œä¸åŒä½ç½®çš„å•è¯å…±äº«ä¸€ä¸ªä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œä¹Ÿæ˜¯ç±»ä¼¼æœ‰è¾“å…¥å±‚ã€éšè—å±‚å’Œè¾“å‡ºå±‚ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œæ—¶åˆ» $t$ çš„éšè—å±‚è¾“å…¥ $\mathbf{h}^{(t)}$ ä¹Ÿä½œä¸ºæ—¶åˆ» $t + 1$ çš„è¾“å…¥ã€‚

å¾ªç¯ç¥ç»ç½‘ç»œå…·æœ‰å¦‚ä¸‹åŸºæœ¬è®¾è®¡ï¼š
1. æ¯ä¸ªæ—¶é—´æ­¥éƒ½æœ‰è¾“å‡ºï¼Œå¹¶ä¸”éšè—å•å…ƒä¹‹é—´æœ‰å¾ªç¯è¿æ¥çš„å¾ªç¯ç½‘ç»œã€‚
2. æ¯ä¸ªæ—¶é—´æ­¥éƒ½äº§ç”Ÿä¸€ä¸ªè¾“å‡ºï¼Œåªæœ‰å½“å‰æ—¶åˆ»çš„è¾“å‡ºåˆ°ä¸‹ä¸ªæ—¶åˆ»çš„éšè—å•å…ƒä¹‹é—´æœ‰å¾ªç¯è¿æ¥çš„å¾ªç¯ç½‘ç»œ
3. åªæœ‰æœ€åä¸€ä¸ªæ—¶é—´æ­¥æ‰æœ‰è¾“å‡ºï¼Œä½†éšè—å•å…ƒä¹‹é—´æœ‰å¾ªç¯è¿æ¥çš„å¾ªç¯ç½‘ç»œã€‚

### 2.1 å‰å‘ä¼ æ’­
æˆ‘ä»¬é‡‡ç”¨æœ€ç»å…¸çš„å¾ªç¯ç¥ç»ç½‘ç»œè¿›è¡Œå…¬å¼æ¨å¯¼ï¼Œå³æ¯ä¸€ä¸ªæ—¶é—´æ­¥éƒ½æœ‰è¾“å‡ºï¼Œä¸”éšè—å•å…ƒä¹‹é—´æœ‰å¾ªç¯è¿æ¥çš„å¾ªç¯ç½‘ç»œã€‚

æ—¶é—´æ­¥ $t$ çš„è¾“å…¥ $\mathbf{x}^{(t)}$ï¼Œéšè—å±‚è¾“å‡ºä¸º $\mathbf{h}^{(t)}$ï¼ŒæŸå¤±å‡½æ•°ä¸º $L^{(t)}$ï¼Œå› æ­¤æœ‰
$$L^{(t)}=-\mathbf{y}^T\log\mathrm{softmax}\left(V\tanh(W\mathbf{h}^{(t-1)}+U\mathbf{x}^{(t)}+\mathbf{b})+\mathbf{c}\right)$$

> å¯ä»¥å‘ç°ä¸å¤šå±‚æ„ŸçŸ¥æœº
> $$L=-\sum_{i=1}^{N}\mathbf{y}_i^T\log\mathrm{softmax}\left(W_2\sigma\left(W_1\mathbf{x}_i+\mathbf{b}_1\right)+\mathbf{b}_2\right)$$
> ä»…ä»…å¤šäº†ä¸€é¡¹ $W\mathbf{h}^{(t-1)}$

æ€»çš„æŸå¤±æ˜¯æ¯ä¸€æ­¥æŸå¤±ä¹‹å’Œ
$$L=\sum_t L^{(t)}$$

å®šä¹‰ä¸­é—´å˜é‡
$$\mathbf{a}^{(t)}=W\mathbf{h}^{(t-1)}+U\mathbf{x}^{(t)}+\mathbf{b}$$
$$\mathbf{h}^{(t)}=\tanh(\mathbf{a}^{(t)})$$
$$\boldsymbol{o}^{(t)}=V\mathbf{h}^{(t)}+\mathbf{c}$$

### 2.2 åå‘ä¼ æ’­
æˆ‘ä»¬å·²ç»çŸ¥é“
$$\frac{\partial L}{\partial \boldsymbol{o}^{(t)}}=\mathrm{softmax}(\boldsymbol{o}^{(t)})-\mathbf{y}_i$$
ä¸èƒ½ç›´æ¥ä½¿ç”¨é“¾å¼æ³•åˆ™ï¼Œå› æ­¤ä½¿ç”¨å¤åˆæ³•åˆ™ï¼Œå³å¾®åˆ†ä¸å¯¼æ•°çš„è”ç³»
$$\begin{aligned}
    \mathrm{d}L&=\mathrm{tr}\left(\sum_t{\frac{\partial L}{\partial \boldsymbol{o}^{(t)}}}^T\mathrm{d}\boldsymbol{o}^{(t)}\right)\\
    &=\mathrm{tr}\left(\sum_t{\frac{\partial L}{\partial \boldsymbol{o}^{(t)}}}^T\mathrm{d}V\mathbf{h}^{(t)}\right)+\mathrm{tr}\left(\sum_t{\frac{\partial L}{\partial \boldsymbol{o}^{(t)}}}^TV\mathrm{d}\mathbf{h}^{(t)}\right)+\mathrm{tr}\left(\sum_t{\frac{\partial L}{\partial \boldsymbol{o}^{(t)}}}^T\mathrm{d}\mathbf{c}\right)
\end{aligned}$$

ç”±ç¬¬äºŒé¡¹å¾—åˆ°
$$\frac{\partial L}{\partial \mathbf{h}^{(t)}}={V\frac{\partial L}{\partial \boldsymbol{o}^{(t)}}}^T$$
è¿›ä¸€æ­¥åœ°åˆ©ç”¨å¤åˆæ³•åˆ™
$$\begin{aligned}
    \mathrm{d}L&=\mathrm{tr}\left(\sum_t{\frac{\partial L}{\partial \mathbf{h}^{(t)}}}^T\mathrm{d}\mathbf{h}^{(t)}\right)\\
    &=\mathrm{tr}\left(\sum_t{\frac{\partial L}{\partial \mathbf{h}^{(t)}}}^T\left(1-(\mathbf{h}^{(t)})^2\right)\odot\mathrm{d}\mathbf{a}^{(t)}\right)\\
    &=\mathrm{tr}\left(\sum_t{ {\frac{\partial L}{\partial \mathbf{h}^{(t)}}}\odot\left(1-(\mathbf{h}^{(t)})^2\right)}^T\mathrm{d}\mathbf{a}^{(t)}\right)
\end{aligned}$$
å› æ­¤å¯ä»¥å¾—åˆ°
$$\frac{\partial L}{\partial W}=\sum_t{ {\frac{\partial L}{\partial \mathbf{h}^{(t)}}}\odot\left(1-(\mathbf{h}^{(t)})^2\right)}{\mathbf{h}^{(t-1)}}^T$$
å…¶ä»–çš„æ±‚å¯¼ç»“æœä¸å¤šå±‚æ„ŸçŸ¥æœºç±»ä¼¼ï¼Œä»ç•¥ã€‚

## 3. é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œæ¨¡å‹
å¾ªç¯ç¥ç»ç½‘ç»œçš„ä¸€å¤§é—®é¢˜åœ¨äºæ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸ï¼Œå¾ˆéš¾å»ºç«‹é•¿æ—¶é—´é—´éš”çš„çŠ¶æ€ä¾èµ–å…³ç³»ã€‚é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œé€šè¿‡å¼•å…¥é—¨æ§æœºåˆ¶ï¼Œä»è€Œæœ‰æ•ˆè§£å†³å¾ªç¯ç¥ç»ç½‘ç»œå­˜åœ¨é—®é¢˜ã€‚

LSTM ç½‘ç»œå¼•å…¥ä¸€ä¸ªæ–°çš„å†…éƒ¨çŠ¶æ€ $\mathrm{c}_t$ï¼Œä¸“é—¨è¿›è¡Œçº¿æ€§çš„å¾ªç¯ä¿¡æ¯ä¼ é€’ï¼ŒåŒæ—¶éçº¿æ€§çš„è¾“å‡ºä¿¡æ¯ç»™éšè—å±‚çš„å¤–éƒ¨çŠ¶æ€ $\mathrm{h}_t$ï¼Œå®ƒä»¬å…·æœ‰å¦‚ä¸‹å…³ç³»
$$\mathbf{c}_t=\boldsymbol{f}_t\odot\mathbf{c}_{t-1}+\boldsymbol{i}_t\odot \tilde{\mathbf{c}}_t$$
$$\mathbf{h}_t=\boldsymbol{o}_t\odot \tanh(\mathbf{c}_t)$$
å…¶ä¸­ $\boldsymbol{f}_t,\boldsymbol{i}_t,\boldsymbol{o}_t\in[0,1]$ æ˜¯ä¸‰ä¸ªé—¨æ¥æ§åˆ¶ä¿¡æ¯ä¼ é€’çš„è·¯å¾„ã€‚$\tilde{\mathbf{c}}_t$ æ˜¯é€šè¿‡éçº¿æ€§å‡½æ•°å¾—åˆ°çš„å€™é€‰çŠ¶æ€
$$\tilde{\mathbf{c}}_t=\tanh(W_c\mathbf{x}_t+U_c\mathbf{h}_{t-1}+\mathbf{b}_c)$$
åœ¨æ¯ä¸ªæ—¶åˆ»ï¼ŒLSTM ç½‘ç»œå†…éƒ¨çŠ¶æ€ $\mathbf{c}_t$ è®°å½•äº†åˆ°å½“å‰æ—¶åˆ»ä¸ºæ­¢çš„å†å²ä¿¡æ¯ã€‚

- é—å¿˜é—¨ $\boldsymbol{f}_t$ æ§åˆ¶ä¸Šä¸€æ—¶åˆ»çš„å†…éƒ¨çŠ¶æ€ $\mathbf{c}_{t-1}$ éœ€è¦é—å¿˜å¤šå°‘ä¿¡æ¯ã€‚
- è¾“å…¥é—¨ $\boldsymbol{i}_t$ æ§åˆ¶å½“å‰æ—¶åˆ»çš„å€™é€‰çŠ¶æ€ $\tilde{\mathbf{c}}_t$ æœ‰å¤šå°‘ä¿¡æ¯éœ€è¦ä¿å­˜ã€‚
- è¾“å‡ºé—¨ $\boldsymbol{o}_t$ æ§åˆ¶å½“å‰æ—¶åˆ»çš„å†…éƒ¨çŠ¶æ€ $\mathbf{c}_{t}$ æœ‰å¤šå°‘ä¿¡æ¯éœ€è¦è¾“å‡ºç»™å¤–éƒ¨çŠ¶æ€ $\mathbf{h}_t$ã€‚
  
ä¸‰ä¸ªé—¨çš„è®¡ç®—æ–¹å¼ä¸º
$$\boldsymbol{f}_t=\sigma (W_f\mathbf{x}_t+U_f\mathbf{h}_{t-1}+\mathbf{b}_f)$$
$$\boldsymbol{i}_t=\sigma (W_i\mathbf{x}_t+U_i\mathbf{h}_{t-1}+\mathbf{b}_i)$$
$$\boldsymbol{o}_t=\sigma (W_o\mathbf{x}_t+U_o\mathbf{h}_{t-1}+\mathbf{b}_o)$$

ç»™å‡ºäº† LSTM ç½‘ç»œçš„å¾ªç¯å•å…ƒç»“æ„ï¼Œå…¶è®¡ç®—è¿‡ç¨‹ä¸ºï¼š
1. é¦–å…ˆåˆ©ç”¨ä¸Šä¸€æ—¶åˆ»çš„å¤–éƒ¨çŠ¶æ€ $\mathbf{h}_{t-1}$ å’Œå½“å‰æ—¶åˆ»çš„è¾“å…¥ $\mathbf{x}_t$ï¼Œè®¡ç®—å‡ºä¸‰ä¸ªé—¨ï¼Œä»¥åŠå€™é€‰çŠ¶æ€ $\tilde{\mathbf{c}}_t$ï¼›
2. ç»“åˆé—å¿˜é—¨ $\boldsymbol{f}_t$ å’Œè¾“å…¥é—¨ $\boldsymbol{i}_t$ æ¥æ›´æ–°è®°å¿†å•å…ƒ $\mathbf{c}_t$ï¼›
3. ç»“åˆè¾“å‡ºé—¨ $\boldsymbol{o}_t$ï¼Œå°†å†…éƒ¨çŠ¶æ€çš„ä¿¡æ¯ä¼ é€’ç»™å¤–éƒ¨çŠ¶æ€ $\mathbf{h}_{t}$

å¾ªç¯ç¥ç»ç½‘ç»œä¸­çš„éšçŠ¶æ€ ğ’‰ å­˜å‚¨äº†å†å²ä¿¡æ¯ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§è®°å¿†ï¼ˆMemoryï¼‰. åœ¨ç®€å•å¾ªç¯ç½‘ç»œä¸­ï¼ŒéšçŠ¶æ€æ¯ä¸ªæ—¶åˆ»éƒ½ä¼šè¢«é‡å†™ï¼Œå› æ­¤å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§çŸ­æœŸè®°å¿†ï¼ˆShort-Term Memoryï¼‰. åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œé•¿æœŸè®°å¿†ï¼ˆLong-Term Memoryï¼‰å¯ä»¥çœ‹ä½œæ˜¯ç½‘ç»œå‚æ•°ï¼Œéšå«äº†ä»è®­ç»ƒæ•°æ®ä¸­å­¦åˆ°çš„ç»éªŒï¼Œå…¶æ›´æ–°å‘¨æœŸè¦è¿œè¿œæ…¢äºçŸ­æœŸè®°å¿†. è€Œåœ¨ LSTM ç½‘ç»œä¸­ï¼Œè®°å¿†å•å…ƒ ğ’„ å¯ä»¥åœ¨æŸä¸ªæ—¶åˆ»æ•æ‰åˆ°æŸä¸ªå…³é”®ä¿¡æ¯ï¼Œå¹¶æœ‰èƒ½åŠ›å°†æ­¤å…³é”®ä¿¡æ¯ä¿å­˜ä¸€å®šçš„æ—¶é—´é—´éš”. è®°å¿†å•å…ƒ ğ’„ ä¸­ä¿å­˜ä¿¡æ¯çš„ç”Ÿå‘½å‘¨æœŸè¦é•¿äºçŸ­æœŸè®°å¿† ğ’‰ï¼Œä½†åˆè¿œè¿œçŸ­äºé•¿æœŸè®°å¿†ï¼Œå› æ­¤ç§°ä¸ºé•¿çŸ­æœŸè®°å¿†ï¼ˆLong Short-Term Memoryï¼‰